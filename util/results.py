from pandas import DataFrame
from datetime import datetime as dt
import os
from typing import Callable

"""
Convenience functions for presenting and saving results.
"""

def save_and_plot(results: dict[str, DataFrame], plot_fn: Callable[[str, str, DataFrame], None] = None, dir: str = 'results') -> None:
    """
    Saves results into a folder based on current time, and invokes the plot function (if available) into the folder.

    Required arguments:
    * results:dict[str, DataFrame], results generated by Runner.run_all_threaded()
     
    Optional arguments:
    * plot_fn:(save_dir: str, filesafe_name: str, df: DataFrame) -> None, callable function that will plot graph(s) and save them into the provided directory. Default: None
    * dir:str, parent results folder. Default: 'results'
    """
    # Make folder
    folder_path = os.path.join(dir, dt.now().strftime("%d%b%y-%H.%M.%S"))
    os.makedirs(folder_path, exist_ok=True)

    print(f"(!) Saving results to {folder_path}...")
    for exp_dir, df in results.items():
        # convert directory into filesafe name
        filesafe_name = exp_dir.replace(os.path.sep, "_")
        
        # save results into csv
        df.to_csv(os.path.join(folder_path, f"{filesafe_name}_results.csv"))

        # plot (if available)
        if plot_fn is not None:
            plot_fn(folder_path, filesafe_name, df)

        print(f"- Saved results for {exp_dir}.")
    print(f"(!) Saved {len(results)} result(s) into {folder_path}.")